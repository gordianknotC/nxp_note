

## Flutter/Android å°ˆæ¡ˆç›®éŒ„çµæ§‹èªªæ˜

file structure of a flutter project would be look like this
- ğŸ“ FlutterProject
	- ğŸ“° pubspec.yaml 
	- ğŸ“ lib [1]
- 	- ğŸ“ res [2]
	- ğŸ“ android [3]
		- ğŸ“ app
			- ğŸ“ libs
			- ğŸ“ src
			- ğŸ“° build.gradle 
		- ğŸ“ res
		- ğŸ“ assets
		- ğŸ“° build.gradle
		- ğŸ“° settings.gradle
		- ğŸ“° local.properties 

>[1]  libraries written in dart.
>[2] android resource folder for flutter project,  generated by flutter.
>[3]  an android project wrapper for flutter, which contains following structure
>- ğŸ“ app
>     - ğŸ“° build.gradle
>     - ğŸ“° local.properties 
>- ğŸ“ res
>- ğŸ“ assets
>- ğŸ“° build.gradle
>- ğŸ“° settings.gradle
> 


### èªªæ˜Android Project wrapper for flutter
#### file structure
- **FlutterProject > android**
	- ğŸ“ app[^1]
		- ğŸ“ libs
		- ğŸ“ src
		- ğŸ“° build.gradle [^2]
	- ğŸ“ res[^*]
	- ğŸ“ assets[^*]
	- ğŸ“° build.gradle[^3]
	- ğŸ“° settings.gradle[^4]
	- ğŸ“° local.properties [^5]


**[1] app** your existing android project 
 #### [1] app folder - ç¾æœ‰androidå°ˆæ¡ˆ

 >éœ€å°‡å…¶folderæ”¹åç‚ºappï¼Œappä¼¼ä¹ç‚ºflutteré»˜èªçš„androidå°ˆæ¡ˆåç¨±ï¼Œä»¥å‘ŠçŸ¥flutterå°ˆæ¡ˆè¨­å®šçš„ä½ç½®(build.gradle, settings.gradle)ï¼Œå¦‚æœä¸ç”¨é»˜èªçš„åç¨±ä¼¼ä¹ä¹Ÿå¯ä»¥ï¼Œä½†éœ€è¦è¨­å®šproject.nameåŠinclude nameï¼Œå¾Œæ–‡æœƒå¯«åˆ°ã€‚
>
>android project folder, this would be your existing android project renamed to "app".  "app" seems like a default naming convention for flutter to indicate project entry folder where configurations(build.gradle and local.properties) locates. For not using convention name, you need to setup project name and include name in build.gradle, which will refer later on.
 
------------------------------------------------
 
**[2] build.gradle** : build script for existing android project
#### androidå°ˆæ¡ˆè¨­å®šæª” 
>è‹¥è¦å°‡ç¾æœ‰å°ˆæ¡ˆèˆ‡flutteré€£çµ,éœ€åœ¨è©²è¨­å®šæª”ä¸­å¯«å…¥ä»¥ä¸‹è³‡è¨Š
- è¼‰å…¥local.properties
- flutterRoot 
- flutterProject
- apply pluginId **&** apply from
- sourceSets
- applicationId
- dependencies

> #### local.properties
> indicates where flutter.sdk and android.sdk locate.
```groovy
	def localProperties = new Properties()  
	def localPropertiesFile = rootProject.file('local.properties')  
	if (localPropertiesFile.exists()) {  
	    localPropertiesFile.withReader('UTF-8') { reader ->  
	        localProperties.load(reader)  
	    }  
	}
```
> ä¸»è¦è¨˜éŒ„äº†flutter.sdkåŠandroid.sdkçš„ä½ç½®, ä»‹ç”±è®€å– local.properties ä»¥æ³¨å…¥flutter
> - rootProject æŒ‡å‘ android , 
> - localPropertiesFile  æŒ‡å‘ android/local.properties

> #### flutterRoot
> read flutter sdk from local.properties into flutterRoot
```groovy
	def flutterVersionCode = localProperties.getProperty('flutter.versionCode')  
	if (flutterVersionCode == null) {  
	    flutterVersionCode = '1'  
	}  
	def flutterVersionName = localProperties.getProperty('flutter.versionName')  
	if (flutterVersionName == null) {  
	    flutterVersionName = '1.0'  
	}
	def flutterRoot = localProperties.getProperty('flutter.sdk')  
	if (flutterRoot == null) {  
	    throw new GradleException("Flutter SDK not found. Define location with flutter.sdk in the local.properties file.")  
	}
```

> #### flutterProject
> specify where flutterProject locates, default value are "../.."
```groovy
	def flutterProject = '../..'
	flutter {  
	    source flutterProject  
	}
```

> #### apply plugin | apply from
> contains following two sections
>  - apply plugins like kotlin which indicates a valid pluginId implmented the plugin interface by project requirements.
>  - apply a build script from flutter
```groovy
	apply plugin: 'com.android.application'  
	apply plugin: 'kotlin-android'  
	apply from: "$flutterRoot/packages/flutter_tools/gradle/flutter.gradle"
```

> #### sourcesSet
> set entry point for finding sources
> - java source
> - res source
	> res åˆ†ç‚ºäºŒå€‹éƒ¨ä»½ï¼Œä¸€å€‹æ˜¯åŸæœ‰å°ˆæ¡ˆçš„res, å¦ä¸€å€‹å‰‡ç‚ºflutterå°ˆæ¡ˆæ‰€éœ€è¦çš„ resï¼Œç”±flutterè‡ªå‹•ç”¢ç”Ÿ
>   - res resource of existing android project
>   - res source of current flutter project	
> - assets source
```groovy
	android {  
		sourceSets {  
			main {  
				//manifest.srcFile "src/main/AndroidManifest.xml"  
				java.srcDirs += ['src/main/kotlin', 'src/main/java']  
				res.srcDirs += ['res', flutterProject + '/res']  
				assets.srcDirs += ['assets', flutterProject + '/assets']  
			}  
```

> #### applicationId
> 
```groovy
	android {
		defaultConfig {  
			// applicationId will replace package name specified in AndroidManifest.xml  
			applicationId "com.gknot"  
			minSdkVersion 19  
			targetSdkVersion 28  
			versionName flutterVersionName  
			testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"  
		}
```

> #### dependencies
```groovy
	dependencies {  
		implementation fileTree(include: '*.jar', dir: 'libs')  
		implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"  
		//following dependencies depends on flutter  
		testImplementation 'junit:junit:4.12'  
		androidTestImplementation 'com.android.support.test:runner:1.0.2'  
		androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.2'  
	}
```
[file](build.gradle.andoirdpj)

------------------------------------------------

**[*]res and assets** for existing android project
#### è¨­ç½®androidå°ˆæ¡ˆ res & assets
> æ–¼ä¸Šè¿°build.gradleä¸­è¨­å®š

------------------------------------------------

**[3] build.gradle [4] setting.gradle** for flutter building android
#### flutter android build å°ˆæ¡ˆè¨­å®šæª”
- **build.gradle**
	- kotlin & gradle dependencies
	- add buildDir
	- add existing android project into subproject
	- add clean build
- **settings.gradle**
	- include subproject
	- add flutter plugin
 
```groovy
	// -------------------
	// flutterProject/android/build.gradle....
	buildscript {  
		ext.kotlin_version = '1.3.21'  
		dependencies {  
			classpath 'com.android.tools.build:gradle:3.3.1'  
			classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"  
		}  
	}  
	rootProject.buildDir = '../build'  
	subprojects {  
		project.buildDir = "${rootProject.buildDir}/${project.name}"  
	}  
	subprojects {  
		project.evaluationDependsOn(':app')  
	}  
	task clean(type: Delete) {  
		delete rootProject.buildDir  
	}

	// -------------------
	// flutterProject/android/settings.gradle....
	include ':app'  
	def flutterProjectRoot = rootProject.projectDir.parentFile.toPath()  
	def plugins = new Properties()  
	def pluginsFile = new File(flutterProjectRoot.toFile(), '.flutter-plugins')  
	if (pluginsFile.exists()) {  
	    pluginsFile.withReader('UTF-8') { reader -> plugins.load(reader) }  
	}  
	plugins.each { name, path ->  
	    def pluginDirectory = flutterProjectRoot.resolve(path).resolve('android').toFile()  
	    include ":$name"  
	  project(":$name").projectDir = pluginDirectory  
	}
```
> **[NOTE]** the **colon** in Gradle uses to describe paths to subprojects. For example,
> evaluationDependsOn(':api:producer')
> would look for the subproject  `producer`  of the subproject  `api`.

------------------------------------------------

**[5] local.properties**
#### é€£çµandroid sdk, flutter sdk
```groovy
	sdk.dir=D:/Users/gordianknot/AppData/Local/Android/android-sdk  
	flutter.sdk=E:\\flutter  
	flutter.versionName=1.0.0  
	flutter.versionCode=1  
	flutter.buildMode=debug
```  

### æœªå®Œæˆ
ä¸Šè¿°æ–¹æ³•ç”¨äº†flutter i18n plugin å¾Œç”±æœƒåœ¨ res/value åº•ä¸‹åŠ å…¥ string_xx.arb ,å°è‡´ç·¨è­¯æ™‚å‡ºç¾ "file name must end with .xml", ç›®å‰æ‰¾ä¸åˆ°åˆé©çš„è§£æ±ºæ–¹æ³•ï¼Œåªå¥½æ‰‹å‹•æŠŠflutter çš„ resource copy åˆ° åŸ android å°ˆæ¡ˆä¸­ï¼Œä¸¦æŠŠ
```groovy
	android {  
		sourceSets {  
			main {  
				//manifest.srcFile "src/main/AndroidManifest.xml"  
				java.srcDirs += ['src/main/kotlin', 'src/main/java']  
				//res.srcDirs += ['res', flutterProject + '/res']  
				res.srcDirs += ['res']  
				assets.srcDirs += ['assets', flutterProject + '/assets']  
			}  
```
æˆ–è€…åªå¥½åœç”¨ android studio Flutter i18n çš„ plugin



 
```mermaid
graph LR
	fdk((flutter sdk))
	adk((android sdk))
	
	dfb{buildDir}
	abuild((android build))
	fpgn((flutter plugin))
	style abuild stroke-width:6px   
	style fpgn stroke-width:6px 
	style dfb stroke-width:6px 
	
	loc(local.properties)
	style loc stroke-width:4px   
	
	set(setting.gradle)
	b1(android wrapper - build.gradle)
	b2(android project - build.gradle)
	style b1 stroke-width:4px, stroke:#7bc
	style b2 stroke-width:4px, stroke:#7bc
	style set stroke-width:4px, stroke:#7bc

	dfp(flutterProjectRoot-resolve project path)
	
	
	dandroid(dependencies-androidProject)
	dflutter(dependencies-buildFlutter)
	dsub(subproject-relationship)
	style dandroid stroke-width:4px, stroke-dasharray: 5
	style dflutter stroke-width:4px, stroke-dasharray: 5
	style dsub stroke-width:4px, stroke-dasharray: 5
	
	
subgraph one
	subgraph path resolving
		fdk -.-> loc
		adk -.-> loc
	end

	loc -.read path information .-> b2
	subgraph android project resolving
		b2 -.- abuild
	end
	dfp -.- b2
	subgraph projectPath&plugin resolving
		set-.->dfp
		set -.- fpgn
	end
	dandroid -.- b2
	subgraph resolving flutter build
		b1 -.- dfb
		
		dflutter -.- b1
		dsub -.- b1
		dflutter -.- dsub
		dsub-.- dandroid
	end
end
```
 
![img](flutter_android_structure.png)
